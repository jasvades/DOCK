<html>
<head>
    
	<!-- set map CSS style -->
	<style>
		#map {
			height:100%;
			width:100vw;
			padding:0px;
			margin:0px;
		}
		@keyframes fade { 
			from { opacity: 0.25; } 
		}

		.blinking {
			animation: fade 2s infinite alternate;
		}

		.easybutton {
			opacity: 1;
			padding: 0;
			font-size: 18;
		}
		
		.leaflet-bar button,
		.leaflet-bar button:hover {
		  background-color: #fff;
		  border: none;
		  border-bottom: 1px solid #ccc;
		  width: 26px;
		  height: 26px;
		  line-height: 26px;
		  display: block;
		  text-align: center;
		  text-decoration: none;
		  color: black;
		}

		.leaflet-bar button {
		  background-position: 50% 50%;
		  background-repeat: no-repeat;
		  display: block;
		}

		.leaflet-bar button:hover {
		  background-color: #f4f4f4;
		}

		.leaflet-bar button:first-of-type {
		  border-top-left-radius: 4px;
		  border-top-right-radius: 4px;
		}

		.leaflet-bar button:last-of-type {
		  border-bottom-left-radius: 4px;
		  border-bottom-right-radius: 4px;
		  border-bottom: none;
		}

		.leaflet-bar.disabled,
		.leaflet-bar button.disabled {
		  cursor: default;
		  pointer-events: none;
		  opacity: .4;
		}

		.easy-button-button .button-state{
		  display: block;
		  position: relative;
		}

		.leaflet-touch .leaflet-bar button {
		  width: 30px;
		  height: 30px;
		  line-height: 30px;
		}
		
		.tooltip{
			position: relative;
			display: inline;
		}
		
		.tooltip:after{
			font-size: 9pt;
			display: block;
			visibility: hidden;
			position: absolute;
			bottom: 0;
			left: 120%;
			opacity: 0;
			content: attr(tooltip); /* might also use attr(title) */
			height: auto;
			min-width: 100px;
			padding: 5px 8px;
			z-index: 999;
			color: #000; /* textcolor */
			text-decoration: none;
			text-align: center;
			background: rgba(255,255,255,0.85); /* backgroundcolor */
			-webkit-border-radius: 5px;
			-moz-border-radius: 5px;
			border-radius: 5px;
		}
		
		.tooltip:before {
			position: absolute;
			visibility: hidden;
			width: 0;
			height: 0;
			left: 120%;
			bottom: 0px;
			opacity: 0;
			content: "";
			border-style: solid;
			border-width: 6px 6px 0 6px;
			border-color: rgba(255,255,255,0.85) transparent transparent transparent;
		}
		
		.tooltip:hover:after{
			visibility: visible;
			opacity: 1;
			bottom: 20px;
		}
		
		.tooltip:hover:before{
			visibility: visible;
			opacity: 1;
			bottom: 14px;
		}
		
		.dot {
		  height: 1em;
		  width: 1em;
		  border-radius: 50%;
		  display: inline-block;
		}
		</style>

	<!-- ensure mobile compatibility -->	
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		
	<!-- load leaflet API -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
	integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="crossorigin=""/>
		
	<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
	integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="crossorigin="">
	</script>

	<!-- load leaflet extensions -->
	<script src="leaflet-realtime.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.4.0/gpx.min.js"></script>
    <script src="leaflet.measure.js"></script>
    <script src="easy-button.js"></script>
    <script src='togpx.js'></script>
    <script src="FileSaver.js"></script>
	<script src="https://unpkg.com/ionicons@5.0.0/dist/ionicons.js"></script>

	<!-- load google API -->
	<script src="https://apis.google.com/js/api.js"></script>

	<!-- load jQuery -->
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	
	<!-- load supporting functions -->    
	<div id="map"></div>
	
	<script>
		var map;
		var isMobile = (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent));
		
		<!-- set mobile settings -->
		if(isMobile){
			map_div = document.getElementById("map")
			map_div.style.setProperty('-webkit-touch-callout', 'none');
			map_div.style.setProperty('-webkit-user-select', 'none');
			map_div.style.setProperty('-ms-user-select', 'none');
			map_div.style.setProperty('user-select', 'none');
		}
		
		<!-- alert script errors -->
		window.onerror=function(msg, url, linenumber){
			if(! isMobile){
				alert('Error message: '+msg+'\nURL: '+url+'\nLine Number: '+linenumber)
			}
			return true
		}
		

		var tileLayers;
				
		function initialiseMap() {
			var map = L.map('map', {closePopupOnClick: false, zoomControl: false}).fitWorld();
			
			var tileURLs = new Array();
			
			tileURLs['thunderforest - landscape'] = 'https://tile.thunderforest.com/landscape/{z}/{x}/{y}{r}.png?apikey=f3489ae724f24f8596a74bac7100dabd';
			tileURLs['mapbox - streets'] = 'https://api.mapbox.com/styles/v1/mapbox/streets-v11/tiles/{z}/{x}/{y}?access_token={accessToken}';
			tileURLs['mapbox - satellite'] = 'https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token={accessToken}';
			tileURLs['mapbox - satellite&streets'] = 'https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v11/tiles/{z}/{x}/{y}?access_token={accessToken}';
			tileURLs['openstreetmap - classic'] = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
			
			tileLayers = new Array();
			
			for (var tile_key in Object.keys(tileURLs)) {
				tileLayers[Object.keys(tileURLs)[tile_key]] = L.tileLayer(tileURLs[Object.keys(tileURLs)[tile_key]], {
					attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a>' + 'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
					accessToken: 'pk.eyJ1IjoiZHJvcHBpbmdjaGlrYSIsImEiOiJja2dkdXQ4aTQwbXBqMnJsZXNsNTRqdG53In0.H_xtqAmm1KwWN_vQA7Vb-g',
					maxNativeZoom:19,
					maxZoom:19
				});
			}

			tileLayers['openstreetmap - classic'].addTo(map);
			
			L.control.layers(tileLayers).addTo(map);
			L.control.scale().addTo(map);
			L.control.zoom({
				fontSize: '18px',
				height: '1.65em',
				width: '1.65em'
			}).addTo(map);
			
			return map;					
		}

		<!-- coordinates pop-up -->
		var popup = L.popup();
		var idleTime;
		
		function onMapClick(event) {
			if (measure_control._measuring) {
				return
			}
			
			var popupOpen = false;
			var today = new Date;
			idleTime = today.getTime();
			
			map.eachLayer(function(layer) {
				if(layer instanceof L.Marker) {
					if(layer.isPopupOpen()){
						layer.closePopup();
						popupOpen = true;
					}
				}	
			});
			
			if (popup.isOpen() && event.type === 'mousedown'){
				popup.remove();
				popupOpen = true;	
			}
			else if (! popupOpen && event.type === 'mousedown' && ! isMobile){
				popup
				.setLatLng(event.latlng)
				.setContent("De coördinaten van dit punt zijn: " + event.latlng.toString().substring(6))
				.openOn(this);
			}
			else if (! popupOpen && event.type === 'contextmenu' && isMobile){
				event.preventDefault;
				popup
				.setLatLng(event.latlng)
				.setContent("De coördinaten van dit punt zijn: " + event.latlng.toString().substring(6))
				.openOn(this);
			}
		}
		
		
		var position;
		var my_location;
		var my_location_radius;						
		function onLocationFound(e) {
			var radius = e.accuracy;
			
			position = e.latlng;
			if(my_location === undefined){
				my_location = L.marker(e.latlng).addTo(map)
				.bindPopup("Je bent maximaal " + Math.round(radius) + " meter van dit punt").openPopup();

				my_location_radius = L.circle(e.latlng, radius).addTo(map);
				map.setZoom(16);
				map.setView(position);
			}
			else{
				hist_locations.addLayer(new L.polyline([my_location.latlng, e.latlng]));
				my_location
				.setLatLng(e.latlng);
				my_location_radius
				.setLatLng(e.latlng)
				.setRadius(radius);
			}
		}

		
		function onLocationError(e) {
			alert(e.message);
		}
		
		
		function enableLocationTracking(map){
			L.easyButton({
				states: [{
					stateName: 'enable',
					icon:      '<span class="easybutton"><ion-icon size="small" name="navigate-outline"></ion-icon></span>',
					title:     'enable GPS location',
					onClick: function(btn, map) {
						map.locate({
							setView: false,
							watch: true,
							enableHighAccuracy: true});  
						btn.state('recalculate'); // change state on click!
					}
					},
					{
						stateName: 'recalculate',
						icon:      '<span class="easybutton"><ion-icon size="small" name="navigate"></ion-icon></span>',
						title:     'click to recalculate position',
						onClick: function(btn, map) {
							map.setView(position);
						}
					}]}
				).addTo( map );
			}
		
		
		var hist_locations = new L.layerGroup();
		var tracking_on = false;

		function enableHistoryLocationTracking(map){
			L.easyButton({
				states: [{
					stateName: 'enable',
					icon:      '<span class="easybutton">&#10561;</ion-icon></span>',
					title:     'enable GPS tracking',
					onClick: function(btn, map) {
						map.locate({
							setView: false,
							watch: true,
							enableHighAccuracy: true});
						btn.state('disable'); // change state on click!
						tracking_on = true;
					}
					},
					{
						stateName: 'disable',
						icon:      '<span class="easybutton"><ion-icon size="small" name="download"></ion-icon></span>',
						title:     'click to disable tracking and save track',
						onClick: function(btn, map) {
							btn.state('enable');
							
							map.stopLocate();
							tracking_on = false;
							map.removeLayer(my_location);
							map.removeLayer(my_location_radius);
							my_location = undefined;
							my_location_radius = undefined;
							
							var filename = prompt('Give the filename to store the GPX file');
							if (filename != null){
								var gpx_file = togpx(hist_locations.toGeoJSON());
								var blob = new Blob([gpx_file], { type: "text/plain;charset=utf-8" });
				            	if(! (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent))){
									saveAs(blob, filename + ".gpx");
				            	}
								else {
				            		alert(gpx_file);
									var fileURL = URL.createObjectURL(blob);
									window.open(fileURL);
								}
							}
						}
					}]}
				).addTo( map );
			}
		
		
		var measure_control;
		
		function enableMeasure(map){
			measure_control = L.control.measure({
				position: 'topleft',
				keyboard: true,	//  weather to use keyboard control for this plugin
				activeKeyCode: 'M'.charCodeAt(0),	//  shortcut to activate measure
				cancelKeyCode: 27,	//  shortcut to cancel measure, defaults to 'Esc'
				lineColor: '#a8250d',
				lineWeight: 2,
				lineDashArray: '1, 0',
				lineOpacity: 1,
				// formatDistance: function (val) {
					//   return Math.round(1000 * val / 1609.344) / 1000 + 'mile';
					// }
			}).addTo(map)
		}		
		
				
		function loadSheetsOnce(map, sheetsUrl, googleApiKey) {
			var locations = [];
			
			// Replace the ID of your Google spreadsheet (containing latitude and longitude columns) and you API key in the URL, returning JSON:
			// https://sheets.googleapis.com/v4/spreadsheets/ID_OF_YOUR_GOOGLE_SPREADSHEET/values/Sheet1!A2:Q?key=YOUR_API_KEY
			// Also make sure your API key is authorised to access Google Sheets API - you can enable that through your Google Developer console.
			$.getJSON(
				"https://sheets.googleapis.com/v4/spreadsheets/" + sheetsUrl + "?key=" + googleApiKey,
				function(data) {
					// data.values contains the array of rows from the spreadsheet. Each row is also an array of cell values.
					$(data.values).each(function() {
						if( (Number(parseFloat(this[9])) === parseFloat(this[9])) && (Number(parseFloat(this[8])) === parseFloat(this[8])) ){
							locations.push([parseFloat(this[9]), parseFloat(this[8])]);
							labels_1.push(this[0]);
							labels_2.push(this[2]);
							labels_3.push(this[3]);
						}
					}
				);
				for (var i = 0; i < locations.length; i++) {
					var marker = L.marker(locations[i]).addTo(map);
				}
			});
		}
		
		
		function enableRealtimeLocationsSheets(map){
			L.easyButton({
				states: [{
					stateName: 'enable',
					icon:      '<span class="easybutton"><ion-icon size="small" name="eye-outline"></ion-icon></span>',
					title:     'enable realtime locations import via google sheets',
					onClick: function(btn, map){
						var sheetsUrl = prompt( 'geef de spreadsheet ID & eventueel sheet name + range (in volgende formaat: <id>/values/Sheet1!A1:Z)' );
						var googleApiKey = prompt( 'geef je Google API Key' );
						if(sheetsUrl != '' && googleApiKey != '' && sheetsUrl != null && googleApiKey != null){
							loadSheetsRealtime(map, sheetsUrl, googleApiKey);
							btn.state('disable'); // change state on click!
						}
					}
					},
					{
						stateName: 'disable',
						icon:      '<span class="easybutton"><ion-icon size="small" name="eye"></ion-icon></span>',
						title:     'disable realtime locations',
						onClick: function(btn, map) {
							btn.state('enable'); // change state on click!
						}
					}]}
			).addTo( map );
		}
		
		
		function loadSheetsRealtime(map, sheetsUrl, googleApiKey) {						
			realtime = realtimeLocations(
				function(success, error) {
					
					$.getJSON(
						// Replace the ID of your Google spreadsheet (containing latitude and longitude columns) and you API key in the URL, returning JSON:
						// https://sheets.googleapis.com/v4/spreadsheets/ID_OF_YOUR_GOOGLE_SPREADSHEET/values/Sheet1!A2:Q?key=YOUR_API_KEY
						// Also make sure your API key is authorised to access Google Sheets API - you can enable that through your Google Developer console.
						"https://sheets.googleapis.com/v4/spreadsheets/" + sheetsUrl + "?key=" + googleApiKey,
						function(data) {														
							var locations = [];
							var labels_1 = [];						
							var labels_2 = [];						
							var labels_3 = [];						
							var labels_4 = [];						
							var labels_5 = [];
							
							// data.values contains the array of rows from the spreadsheet. Each row is also an array of cell values.							
							$(data.values).each(function() {
								if( (Number(parseFloat(this[9])) === parseFloat(this[9])) && (Number(parseFloat(this[8])) === parseFloat(this[8])) ){
									locations.push([parseFloat(this[9]), parseFloat(this[8])]);
									labels_1.push(this[0]);
									labels_2.push(this[2]);
									labels_3.push(this[3]);
								}
							});
							locations = convertGeoJson(locations, labels_1, labels_2, labels_3, labels_4, labels_5);
							
							success(locations);
						}).catch(error);
					},
				map);
				
			return realtime;
				
		}
		
		var realTimeGroup = new L.featureGroup;
		
		function realtimeLocations(function_locations, map){
			realtime = L.realtime(function_locations, {
				interval: 3000,
				container: realTimeGroup,
				getFeatureId: function(feature) { return feature.properties.featureId; },
				pointToLayer: function(feature, latlng) {
					marker = L.marker(latlng, {
						'icon': L.icon({
							iconUrl: 'https://svgsilh.com/png-512/155457.png',
							//iconUrl: 'https://leafletjs.com/examples/custom-icons/leaf-green.png',
							//shadowUrl: 'https://leafletjs.com/examples/custom-icons/leaf-shadow.png',
							iconSize:     [30, 40], // size of the icon
							className: 'blinking',
							//shadowSize:   [B, H], // size of the shadow
							//iconAnchor:   [B, H], // point of the icon which will correspond to marker's location
							//shadowAnchor: [B, H],  // the same for the shadow
							//popupAnchor:  [B, H] // point from which the popup should open relative to the iconAnchor
						})
					}).bindPopup('<b>' + feature.properties.label_2 + '</b>' + '<br />' + feature.properties.label_3)
					.bindTooltip(feature.properties.label_1, {permanent: true})
					.openTooltip()
					.addTo(map);
					
					L.DomUtil.addClass(marker._icon, 'blinking');
						
					return marker;
						}
			}).addTo(map);
			
			var tochtGroepen = new Array();
			var tochtControl = new L.control.layers(tochtGroepen,null, {collapsed:false}).addTo(map);
			
			realtime.on('update', function() {
				var bounds;						
				
				tochtControl.remove(map);
								
				for (var key in realtime._features) {
					feature = realtime._features[key];
					if (tochtGroepen[feature.properties.label_2]){
						if (! tochtGroepen[feature.properties.label_2].hasLayer(realtime._featureLayers[key])){
							tochtGroepen[feature.properties.label_2].addLayer(realtime._featureLayers[key]);
						}
					}
					else {
						tochtGroepen[feature.properties.label_2] = new L.featureGroup;
						tochtGroepen[feature.properties.label_2].addLayer(realtime._featureLayers[key]);
					}
				}
				for (var key in tochtGroepen) {
					tochtControl.removeLayer(tochtGroepen[key]);
					tochtControl.addOverlay(tochtGroepen[key], key);
				}
				
				tochtControl.addTo(map);
											
				bounds = GPXgroup.getBounds();
				bounds.extend(realTimeGroup.getBounds());
				
				var today = new Date;
				var now = today.getTime();
				if(now - idleTime > 10000){
					map.fitBounds(bounds);
				}
			});
			
			return realtime;
			
		}

		function convertGeoJson(locations, labels_1, labels_2, labels_3, labels_4, labels_5){
			var locations_geojson = {};
			locations_geojson.type = 'FeatureCollection';
			locations_geojson.features = [];
			
			$(locations).each(function() {
				var location = {};
				location.type = 'Feature';
				location.properties = {
					featureId: labels_1[locations.indexOf(this)],
					label_1: labels_1[locations.indexOf(this)],
					label_2: labels_2[locations.indexOf(this)],
					label_3: labels_3[locations.indexOf(this)],
					label_4: labels_4[locations.indexOf(this)],
					label_5: labels_5[locations.indexOf(this)]
				};
				location.geometry = {};
				location.geometry.type = 'Point';
				location.geometry.coordinates = [parseFloat(this[0]), parseFloat(this[1])];
				locations_geojson.features.push(location);
			});
			return locations_geojson;
		}
		
		var GPXgroup = new L.featureGroup;
		var GPXcontrol = new L.control.layers(new Array(),null, {collapsed:false});
		
		function loadFiles() {
			var input, file, fr;

			if (typeof window.FileReader !== 'function') {
				alert("The file API isn't supported on this browser yet.");
				return;
			}

			input = document.getElementById('fileinput');
			if (!input) {
				alert("Um, couldn't find the fileinput element.");
			}
			else if (!input.files) {
				alert("This browser doesn't seem to support the `files` property of file inputs.");
			}
			else if (!input.files[0]) {
				alert("Please select a file before clicking 'Load'");
			}
			else {
				GPXcontrol.addTo(map);
				for(var i = 0; i < input.files.length; i++){
					file = input.files[i];
					fr = new FileReader();
					fr.onload = pushToMap;
					fr.fileName = file.name.split('.').slice(0, -1).join('.');
					fr.readAsText(file);
				}
			}
			
			function pushToMap(e){
				
				var GPXtext = e.target.result;

				color = "#"+((1<<24)*Math.random()|0).toString(16);
				gpx = new L.GPX(GPXtext, {
					async: true,
					marker_options: {
						startIconUrl: '',
						wptIconUrls: '',
						endIconUrl: '',
						shadowUrl: ''
					},
					polyline_options: {
						opacity: 0.7,
						color : color,
						weight: 5,
						lineCap: 'round'
					} })
					.on('loaded', function(e) {
						map.fitBounds(GPXgroup.getBounds());
					})
					.addTo(map);
					
					GPXgroup.addLayer(gpx);
					GPXcontrol.addOverlay(gpx, e.target.fileName + ' <span class="dot" style="background-color:' + color + ';"></span>');
				}
		}
		
		
		function enableGPXupload(map) {
			L.easyButton('<span class="easybutton">&#10547;</span>', function(btn, map){ //https://www.htmlsymbols.xyz/arrow-symbols
				var x = document.createElement("input");
				x.setAttribute("type", "file");
				x.setAttribute("accept", "gpx");
				x.setAttribute("id", "fileinput");
				x.setAttribute("multiple", "multiple");
				x.setAttribute("style", "display: none;");
				x.setAttribute("oninput", "loadFiles();");
				document.body.appendChild(x);  
				$('#fileinput').trigger('click');
			}, 'import GPX routes').addTo( map );
		}


		</script>
	</head>
	<body>
		<script>				
			map = initialiseMap();
			map.on('click dblclick mousedown zoomanim contextmenu', onMapClick);
			map.on('locationfound', onLocationFound);
			map.on('locationerror', onLocationError);
			
			enableMeasure(map);
			enableLocationTracking(map);
			enableHistoryLocationTracking(map);
			enableGPXupload(map);
			enableRealtimeLocationsSheets(map);
			//loadSheetsOnce(map, <sheetsID>, <googleAPIkey>);		
			
		</script>				
	</body>
</html>
